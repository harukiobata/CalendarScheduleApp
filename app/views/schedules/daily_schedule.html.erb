<turbo-frame id="daily_schedule">
  <div class="schedule"> 
    <div class="schedule-nav">
      <%= link_to "⬅️ 前日", schedule_path(date: base_date - 1), data: { turbo_frame: "daily_schedule", turbo_stream: true }, class: "schedule-nav__button" %>
      <%= link_to "翌日 ➡️", schedule_path(date: base_date + 1), data: { turbo_frame: "daily_schedule", turbo_stream: true }, class: "schedule-nav__button" %>
    </div>

    <div class="schedule-grid__container">
      <% dates.each do |date| %>
        <% active_time = date_active_times[date] %>
        <div class="schedule-grid__day">
          <h4 class="schedule-grid__date"><%= date.strftime("%-m/%-d (%a)") %></h4>

          <div class="schedule-scroll-inner">
            <div class="time-blocks">
              <% time_blocks_for(active_time.granularity_minutes).each do |block_start, block_end| %>
                <% start_time_str = block_start.strftime("%H:%M") %>
                <% end_time_str = block_end.strftime("%H:%M") %>
                <% enabled = within_active_time?(block_start, block_end, active_time) %>

                <% if enabled %>
                  <%= link_to new_event_path(date: date, start_time: start_time_str, end_time: end_time_str),
                      class: "schedule-grid__block schedule-grid__block--active",
                      data: { turbo_frame: "event_panel" } do %>
                      <span class="schedule-grid__time"><%= start_time_str %></span>
                  <% end %>
                <% else %>
                  <div class="schedule-grid__block schedule-grid__block--inactive">
                    <span class="schedule-grid__time"><%= start_time_str %></span>
                  </div>
                <% end %>
              <% end %>
            </div>

            <div class="events-layer">
              <% (grouped_events[date] || []).each do |event| %>
                <% top = minutes_since_midnight(event.start_time) %>
                <% height = ((event.end_time - event.start_time) / 60).to_i %>
                <div class="event-block" style="top: <%= top %>px; height: <%= height %>px; background-color: <%= category_color(event.category) %>">
                  <div class="event-title"><%= event.title %></div>
                  <div class="event-time"><%= event.start_time.strftime("%H:%M") %> - <%= event.end_time.strftime("%H:%M") %></div>
                </div>
              <% end %>
            </div>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</turbo-frame>
